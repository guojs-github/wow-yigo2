(function(){
	YIUI.Yes_TimePicker = function(options){
		var Return = {
			el : $("<div></div>"),
			id : "",
			dropView: $("<div class='tp-vw'></div>"),
			format : "HH:mm:ss",
			isSecond : false,
			enable: true,
			commitValue : $.noop,
			doFocusOut: $.noop,
			selectValue: null,
			_hasShow : false,
			_needShow : false,
			init : function(){
				this.id = this.id || this.el.attr("id");
				this._input = $("<input type='text' class='txt'>").appendTo(this.el);
		        this._btn = $("<span class='arrow'></span>").appendTo(this.el);
		        this.initTimePicker();
		        this.temp = "";
			},
			isEnable : function(){
				return true;
			},
			getEl: function() {
                return this.el;
            },
			getInput: function() {
                return this._input;
            },
            getBtn: function() {
                return this._btn;
            },
            getDropView : function() {
                return  this.dropView;
            },
            setText : function(value){
            	this._input.val(value);
            	this.el.attr("title", value);
            	this.temp = value;
            },
            getText: function () {
                return this._input.val();
            },
            setBackColor: function (backColor) {
                this.backColor = backColor;
                console.log(this._input);
                this._input.css({
                    'background-image': 'none',
                    'background-color': backColor
                })
            },
            setValue: function(value){
            	this.selectValue = value;
            	
            },
            focus : function(){
            	this._input.focus();
            },
            initTimePicker : function(){
				this.getInput().attr("id","tpInput_"+this.id);
				this.getInput().DateTimeMask({masktype: this.isSecond ? 5 : 4});
				this.getBtn().attr("id","tpImg_"+this.id);
				this.install();
				
			},
			install : function(){
				var self = this;
				this.getBtn().mousedown(function(e){
					self._needShow =  !self._hasShow ? true : false; 
				}).click(function(e){
					if(!self.isEnable()){
						return;
					}
					self._input.addClass("focus");
					self.getInput().focus();
					if(self._hasShow){
						self.hideDateView();
						return;
					}
					self.initDropView();
					$(document.body).append(self.dropView);
					YIUI.PositionUtil.setViewPos(self.getInput(), self.dropView, false);
					
					self.dropView.slideDown(200, function(){
						$(document).on('mousedown', function(e){
							var target = $(e.target);
							if ((target.closest(self.dropView).length == 0) 
								&& (target.closest(self.getBtn()).length == 0) 
								&& (target.closest(self.getInput()).length == 0) ) {
		                        	self.hideDateView();
		                            $(document).off("mousedown");
		                        }
						});
					});

					
					if($(".tp-vw li").hasClass("times")){
						self.location(".times");
					}else{
						self.location(".select");
					}
					
					self._hasShow = true;
					self._needShow = false;
					e.stopPropagation();
				});
				
				
				$("input", self.el).bind("blur", function(e){
					if(!self.isEnable() || self._needShow || self._hasShow){
						return;
					}

					var text = self.getInput().val();
					if(text != self.temp){
						self.temp = text;
						self.commitValue(text.replace(/:/g, ""));
					}
					
					self.doFocusOut();
				});
				
			},
			setWidth : function(width){
				this.el.css('width',width);
				this.getInput().css('width',width);
			},
			setHeight : function(height){
				this.el.css('height',height);
				this.getInput().css('height', height);
			},
			setEditable: function (editable) {
                this.editable = editable;
                var el = this.getInput();
                if (this.editable) {
                    el.removeAttr('readonly');
                } else {
                    el.attr('readonly', 'readonly');
                }
            },
			initDropView : function(){
				this.dropView = $("<div class='tp-vw'></div>")
                this.dropView.attr("id", this.id + "_timePickerView");
                this.dropView.html("");
                this.initHours();
                this.initMinutes();
                if(this.isSecond){
                	this.initSeconds();
                }else{
                	this.dropView.addClass("time");
                }
                
                this.initBtn();
                this.getValue();
               
			},
			initHours : function(){
				var hours =  $("<div class='hours'></div>");
				$("<span class='hours-title'>"+YIUI.I18N.getString("TIMEPICKER_HOURS","时")+"</span>").appendTo(hours);
				var ul = $("<ul class='ul-h'></ul>");
				ul.appendTo(hours);
				var h;
				var str = this.getInput().val();
				var value = str.substring(0,2);
				var date = new Date();
				for (var i = 0; i < 24; i++) {
					h = i<10 ? ("0"+i) : i;
					var li = $("<li class='default'></li>");
					if(value == h){
						li.addClass("select");
					}else if(value == "" && date.getHours() == h){
						li.addClass("times");
					}
					li.text(h);
					li.appendTo(ul);
				}
				this.dropView.append(hours);
			},
			initMinutes : function(){
				var minute =  $("<div class='minutes'></div>");
				$("<span class='minutes-title'>"+YIUI.I18N.getString("TIMEPICKER_MINUTES","分")+"</span>").appendTo(minute);
				var ul = $("<ul class='ul-m'></ul>");
				ul.appendTo(minute);
				var m;
				var str = this.getInput().val();
				var value = str.substring(3,5);
				var date = new Date();
				for (var i = 0; i < 60; i++) {
					m = i<10 ? ("0"+i) : i;
					var li = $("<li class='default'></li>");
					if(value == m){
						li.addClass("select");
					}else if(value == "" && date.getMinutes() == m){
						li.addClass("times");
					}
					li.text(m);
					li.appendTo(ul);
				}
				this.dropView.append(minute);
			},
			initSeconds : function(){
				var second =  $("<div class='seconds'></div>");
				$("<span class='seconds-title'>"+YIUI.I18N.getString("TIMEPICKER_SECONDES","秒")+"</span>").appendTo(second);
				var ul = $("<ul class='ul-s'></ul>");
				ul.appendTo(second);
				var s;
				var str = this.getInput().val();
				var value = str.substring(6,8);
				var date = new Date();
				for (var i = 0; i < 60; i++) {
					s = i<10 ? ("0"+i) : i;
					var li = $("<li class='default'></li>");
					if(value == s){
						li.addClass("select");
					}else if(value == "" && date.getSeconds() == s){
						li.addClass("times");
					}
					li.text(s);
					li.appendTo(ul);
				}
				this.dropView.append(second);
			},
			initBtn : function(){
				var btn =  $("<div class='tp-btn'></div>");
				$("<span class = 'sure'>"+YIUI.I18N.getString("CURRENCY_OK","确定")+"</span>").appendTo(btn);
		    	$("<span class='quarantine'></span>").appendTo(btn);
		    	$("<span class = 'now'>"+YIUI.I18N.getString("TIMEPICKER_NOW","现在") +"</span>").appendTo(btn);
		    	$("<span class='quarantine'></span>").appendTo(btn);
		    	$("<span class = 'removeall'>"+YIUI.I18N.getString("CURRENCY_CLEAN","清除")+"</span>").appendTo(btn);
		    	this.dropView.append(btn);
			},
			hideDateView : function(){
				this.dropView.remove();
				this._input.removeClass("focus");
				this.commitValue(this.selectValue);
				this._hasShow = false;
			},
			getValue : function(){
				var self = this;
				this.dropView.delegate(".sure","click",function(){
					if($(".tp-vw li").hasClass("select")){
						var h = $(".ul-h .select").text() == "" ? "00" :$(".ul-h .select").text();
						var m = $(".ul-m .select").text() == "" ? "00" :$(".ul-m .select").text();
						var s = $(".ul-s .select").text() == "" ? "00" :$(".ul-s .select").text();
						if(self.isSecond){
							self.getInput().val(h + ":" + m + ":" + s);
							self.selectValue = Number(h + m + s);
						}else{
							self.getInput().val(h + ":" + m);
							self.selectValue = Number(h + m);
						}
					}else{
						self.getInput().val();
						self.selectValue = null;
					}
					
					self.hideDateView();
				});
				
				this.dropView.delegate(".removeall","click",function(){
					self.getInput().val("");
					self.selectValue = null;
					self.hideDateView();
				});
				
				this.dropView.delegate(".now","click",function(){
					var date = new Date();
					var hours = date.getHours();
					var minutes = date.getMinutes();
					var seconds = date.getSeconds();
					hours = hours<10 ? "0"+hours : hours;
					minutes = minutes<10 ? "0"+minutes : minutes;
					seconds = seconds<10 ?"0"+seconds : seconds;
					if(self.isSecond){
						self.getInput().val(hours + ":" + minutes+ ":" + seconds);
						self.selectValue = Number("" + hours + minutes + seconds);
					}else{
						self.getInput().val(hours + ":" + minutes);
						self.selectValue = Number("" + hours + minutes);
					}
					
					self.hideDateView();
				});
				
				 this.dropView.delegate("li","click",function(){
	                $(this).addClass("select").siblings().removeClass("select").removeClass("times");
	                var parent = $(this).parent();
	                parent.animate({scrollTop: 
	                	$(this).offset().top - parent.offset().top + parent.scrollTop()}, 300);
	                var h = $(".ul-h .select").text() == "" ? "00" :$(".ul-h .select").text();
					var m = $(".ul-m .select").text() == "" ? "00" :$(".ul-m .select").text();
					
					if(self.isSecond){
						var s = $(".ul-s .select").text() == "" ? "00" :$(".ul-s .select").text();
						self.getInput().val(h + ":" + m + ":" + s);
					}else{
						self.getInput().val(h + ":" + m );
					}
				});
				
			},
			location : function(str){
				$(".ul-h").scrollTop(
						$(".ul-h "+str).offset().top - $(".ul-h").offset().top + $(".ul-h").scrollTop()
				);
				$(".ul-m").scrollTop(
						$(".ul-m "+str).offset().top - $(".ul-m").offset().top + $(".ul-m").scrollTop()
				);
				if(this.isSecond){
					$(".ul-s").scrollTop(
							$(".ul-s "+str).offset().top - $(".ul-s").offset().top + $(".ul-s").scrollTop()
					);
				}
				
			}
			
			
		};
		Return = $.extend(Return, options);
		if(!options.isPortal) {
        	Return.init();
        }
        return Return;
	}
})();