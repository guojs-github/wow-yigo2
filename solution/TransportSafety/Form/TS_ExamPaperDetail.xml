<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Form Key="TS_ExamPaperDetail" Caption="试卷详情" FormType="Entity" Version="158">
    <DataSource RefObjectKey="TS_ExamPaper"/>
    <OperationCollection>
        <Operation Key="New" Caption="新增" Visible="ReadOnly()">
            <Action>
                <![CDATA[New("TS_ExamPaperDetail", "self");]]>
            </Action>
        </Operation>
        <Operation Key="CopyNew" Caption="复制新增" Visible="ReadOnly()">
            <Action>
                <![CDATA[CopyNew();]]>
            </Action>
        </Operation>
        <Operation Key="Delete" Caption="删除" Visible="ReadOnly()&amp;&amp;(Status==StatusValue('PREPARED') || Status==StatusValue('DISABLED'))">
            <Action>
                <![CDATA[SetPara("id", GetOID());
Confirm(
    "是否删除当前试卷？",
    'YES_NO',
    {
        YES:{
            InvokeService("PaperDelete", false, false, ""&GetPara("id"));
            UpdateView(); // 更新关联列表视图
            Close();
        },
        NO:{}
    }
);]]>
            </Action>
        </Operation>
        <Operation Key="Save" Caption="保存" Visible="!ReadOnly()&amp;&amp;Status==StatusValue('PREPARED')">
            <Action>
                <![CDATA[if (!IsNew() && isDeleted()) { return false;};
SaveData();
UpdateView();
]]>
            </Action>
        </Operation>
        <Operation Key="Cancel" Caption="取消" Visible="!ReadOnly()">
            <Action>
                <![CDATA[Confirm("您要放弃保存吗？","YES_NO",{YES:{Cancel();},NO:{}});]]>
            </Action>
        </Operation>
        <Operation Key="Edit" Caption="修改" Visible="ReadOnly()&amp;&amp;Status==StatusValue('PREPARED')">
            <Action>
                <![CDATA[Edit();]]>
            </Action>
        </Operation>
        <Operation Key="GenerateQuestions" Caption="生成试题" Visible="ReadOnly()&amp;&amp;(Status==StatusValue('PREPARED') || Status==StatusValue('DISABLED'))">
            <Action>
                <![CDATA[var generated = GetValue("IsQuestionsGenerated"); // Confirm(generated);
var id = GetOID();
SetPara("id", id);
if (generated <> 0) {
    Confirm(
        "单据已有试题，您要重新生成吗？",
        "YES_NO",
        {
            YES:{
                InvokeService("PaperGenerateQuestions", false, false, ""&GetPara("id"));
                Confirm("试题生成完毕");
                LoadData();
            },
            NO:{}
        }
    );
} else {
    // Confirm("生成试题");
    InvokeService("PaperGenerateQuestions", false, false, ""&id);
    Confirm("试题生成完毕");
    LoadData();
};]]>
            </Action>
        </Operation>
        <Operation Key="Enable" Caption="启用" Visible="ReadOnly()&amp;&amp;(Status==StatusValue('PREPARED') || Status==StatusValue('DISABLED'))">
            <Action>
                <![CDATA[if (isDeleted()) { return false;};
if (!isGenerated()) { return false;};
SetValue("Status", StatusValue("ENABLED"));
SaveData();]]>
            </Action>
        </Operation>
        <Operation Key="Disable" Caption="停用" Visible="ReadOnly()&amp;&amp;Status==StatusValue('ENABLED')">
            <Action>
                <![CDATA[if (isDeleted()) { return false;};
SetValue("Status", StatusValue("DISABLED"));
SaveData();]]>
            </Action>
        </Operation>
        <Operation Key="Preview" Caption="预览">
            <Action>
                <![CDATA[PreviewPaper(GetOID());
]]>
            </Action>
        </Operation>
    </OperationCollection>
    <Body>
        <Block>
            <FlexFlowLayoutPanel Key="panel_main" Caption="根面板">
                <ToolBar Key="main_toolbar" Height="pref" Caption="main_toolbar">
                    <ToolBarItemCollection/>
                </ToolBar>
                <SplitPanel Key="panel_content" Orientation="Vertical" Height="100%" Caption="panel_content">
                    <TabPanel Caption="Tabs" Key="Tabs">
                        <GridLayoutPanel Key="TabBasic" Caption="基本信息">
                            <TextEditor Key="No" Caption="题目编号" BuddyKey="Lab_No" X="1" Y="1" Enable="false" CopyNew="false">
                                <DataBinding ColumnKey="No" TableKey="TS_EXAM_PAPER_HEADER"/>
                            </TextEditor>
                            <Label Key="Lab_No" Caption="试卷编号" X="0" Y="1">
                                <Format HAlign="Right"/>
                            </Label>
                            <Dict Key="Category" Caption="类别" BuddyKey="Lab_Category" X="3" Y="1" ItemKey="MD_Enum">
                                <DataBinding ColumnKey="Category" TableKey="TS_EXAM_PAPER_HEADER" Required="true">
                                    <ValueChanged>
                                        <![CDATA[// 类别变化，生成规则不再适用
clearRule();
]]>
                                    </ValueChanged>
                                </DataBinding>
                                <ItemFilter>
                                    <Filter Query="select oid from md_enum where type = '考题类别'" Type="DataSet"/>
                                </ItemFilter>
                            </Dict>
                            <Label Key="Lab_Category" Caption="类别" X="2" Y="1">
                                <Format HAlign="Right"/>
                            </Label>
                            <Dict Key="Department" Caption="发布部门" BuddyKey="Lab_Department" X="5" Y="1" ItemKey="MD_Enum">
                                <DataBinding ColumnKey="Department" TableKey="TS_EXAM_PAPER_HEADER" Required="true">
                                    <ValueChanged>
                                        <![CDATA[// 发布部门变化，生成规则不再适用
clearRule();
]]>
                                    </ValueChanged>
                                </DataBinding>
                                <ItemFilter>
                                    <Filter Query="select oid from md_enum where type = '发布部门'" Type="DataSet"/>
                                </ItemFilter>
                            </Dict>
                            <Label Key="Lab_Department" Caption="发布部门" X="4" Y="1">
                                <Format HAlign="Right"/>
                            </Label>
                            <ComboBox Key="Status" Caption="状态" BuddyKey="Lab_Status" X="7" Y="1" SourceType="Status" Enable="false" CopyNew="false">
                                <DataBinding ColumnKey="Status" TableKey="TS_EXAM_PAPER_HEADER" DefaultFormulaValue="StatusValue('PREPARED')" Required="true"/>
                            </ComboBox>
                            <Label Key="Lab_Status" Caption="状态" X="6" Y="1">
                                <Format HAlign="Right"/>
                            </Label>
                            <Label Key="Lab_RuleCode" Caption="生成规则" X="0" Y="3">
                                <Format HAlign="Right"/>
                            </Label>
                            <Button Key="SelectRule" Caption="选择规则" X="2" Y="3" Visible="!ReadOnly()">
                                <OnClick>
                                    <![CDATA[ShowModal(
    "TS_ExamRuleSelect", 
    {category:{GetValue("Category")}, department:{GetValue("Department")}}, 
    {
        OK: {
            Close(); // 已经选好了，关闭弹出窗口
            var data = GetSessionPara("SELECTED_RULE");
            parent.updateDataWithRule(data);
        }
    }
);]]>
                                </OnClick>
                            </Button>
                            <TextEditor Key="RuleDescription" Caption="生成规则描述" X="3" Y="3" Enable="false" XSpan="5">
                                <DataBinding ColumnKey="RuleDescription" TableKey="TS_EXAM_PAPER_HEADER"/>
                            </TextEditor>
                            <TextEditor Key="RuleId" Caption="RuleId" X="1" Y="3" Visible="false" Enable="false">
                                <DataBinding ColumnKey="RuleId" TableKey="TS_EXAM_PAPER_HEADER"/>
                            </TextEditor>
                            <NumberEditor Key="TotalScore" Caption="总分" BuddyKey="Lab_TotalScore" X="1" Y="5" Enable="false" Scale="1">
                                <DataBinding ColumnKey="TotalScore" TableKey="TS_EXAM_PAPER_HEADER" CheckRule="TotalScore &gt; 0" Required="true" DefaultValue="0" ErrorInfo="【总分】需要大于0"/>
                            </NumberEditor>
                            <Label Key="Lab_TotalScore" Caption="总分" X="0" Y="5">
                                <Format HAlign="Right"/>
                            </Label>
                            <NumberEditor Key="PassingScore" Caption="合格分" BuddyKey="Lab_PassingScore" X="3" Y="5" Scale="1">
                                <DataBinding ColumnKey="PassingScore" TableKey="TS_EXAM_PAPER_HEADER" CheckRule="(PassingScore &gt; 0) &amp;&amp; (PassingScore &lt;= TotalScore)" Required="true" DefaultValue="0" ErrorInfo="【合格分】需大于零，且小于等于总分"/>
                            </NumberEditor>
                            <Label Key="Lab_PassingScore" Caption="合格分" X="2" Y="5">
                                <Format HAlign="Right"/>
                            </Label>
                            <NumberEditor Key="Duration" Caption="时长(分钟)" BuddyKey="Lab_Duration" X="5" Y="5" Scale="0">
                                <DataBinding ColumnKey="Duration" TableKey="TS_EXAM_PAPER_HEADER" CheckRule="Duration &gt; 0" Required="true" DefaultValue="0" ErrorInfo="【考试时长】需大于0"/>
                            </NumberEditor>
                            <Label Key="Lab_Duration" Caption="时长(分钟)" X="4" Y="5">
                                <Format HAlign="Right"/>
                            </Label>
                            <TextArea Key="Remark" Caption="备注" BuddyKey="Lab_Remark" X="1" Y="7" XSpan="7" YSpan="3">
                                <DataBinding ColumnKey="Remark" TableKey="TS_EXAM_PAPER_HEADER"/>
                            </TextArea>
                            <Label Key="Lab_Remark" Caption="备注" X="0" Y="7">
                                <Format HAlign="Right"/>
                            </Label>
                            <TextEditor Key="IsQuestionsGenerated" Caption="试题生成?" BuddyKey="Lab_IsQuestionsGenerated" X="1" Y="11" Enable="false" Visible="false">
                                <DataBinding ColumnKey="IsQuestionsGenerated" TableKey="TS_EXAM_PAPER_HEADER"/>
                            </TextEditor>
                            <Label Key="Lab_IsQuestionsGenerated" Caption="试题生成?" X="0" Y="11" Visible="false">
                                <Format HAlign="Right"/>
                            </Label>
                            <HyperLink BorderColor="Transparent" BorderStyle="none" BuddyKey="Lab_RuleCode" Enable="true" Key="RuleCode" X="1" Y="3">
                                <DataBinding ColumnKey="RuleCode" TableKey="TS_EXAM_PAPER_HEADER"/>
                                <OnClick>
                                    <![CDATA[openRuleDetail()]]>
                                </OnClick>
                            </HyperLink>
                            <RowDefCollection RowGap="5">
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="10px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="10px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="10px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="5">
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                        <Grid Key="Questions" Caption="试题" NewEmptyRow="false" CanDelete="false" CanInsert="false" CanShift="false" Height="100%" Option="" CopyNew="false">
                            <GridColumnCollection>
                                <GridColumn Key="Select" Caption="选择" Width="80px" Visible="false"/>
                                <GridColumn Key="sequance" Caption="顺序" Enable="false" Width="80px"/>
                                <GridColumn Key="QuestionId" Caption="题目ID" Visible="false" Width="80px"/>
                                <GridColumn Key="QuestionType" Caption="题型" Width="120px" Enable="false"/>
                                <GridColumn Key="QuestionCode" Caption="题目编码" Width="150px"/>
                                <GridColumn Key="Question" Caption="题目内容" Width="400px"/>
                                <GridColumn Key="QuestionOptions" Caption="题目备选项清单" Width="200px"/>
                                <GridColumn Key="QuestionAnswer" Caption="题目答案" Width="200px"/>
                            </GridColumnCollection>
                            <GridRowCollection>
                                <GridRow Key="row1" TableKey="TS_EXAM_PAPER_DETAIL">
                                    <GridCell Key="select" CellType="CheckBox" IsSelect="true"/>
                                    <GridCell Key="sequance">
                                        <DataBinding ColumnKey="Seq"/>
                                    </GridCell>
                                    <GridCell Key="QuestionId" CellSortType="None">
                                        <DataBinding ColumnKey="QuestionId"/>
                                    </GridCell>
                                    <GridCell Key="QuestionType" CellType="Dict" CellSortType="None" ItemKey="MD_Enum" StateMask="Enable|Disable|Discard">
                                        <DataBinding ColumnKey="QuestionType"/>
                                    </GridCell>
                                    <GridCell Key="QuestionCode" CellType="HyperLink" CellSortType="None">
                                        <DataBinding ColumnKey="QuestionCode"/>
                                    </GridCell>
                                    <GridCell Key="Question" CellSortType="None">
                                        <DataBinding ColumnKey="Question"/>
                                    </GridCell>
                                    <GridCell Key="QuestionOptions" CellSortType="None">
                                        <DataBinding ColumnKey="QuestionOptions"/>
                                    </GridCell>
                                    <GridCell Key="QuestionAnswer" CellSortType="None">
                                        <DataBinding ColumnKey="QuestionAnswer"/>
                                    </GridCell>
                                </GridRow>
                            </GridRowCollection>
                        </Grid>
                        <GridLayoutPanel Key="TabSystem" Caption="系统信息">
                            <Dict Key="Creator" Caption="创建人" BuddyKey="Lab_Creator" X="1" Y="1" Enable="false" ItemKey="Operator" CopyNew="false" StateMask="Enable|Disable|Discard">
                                <DataBinding ColumnKey="CREATOR" TableKey="TS_EXAM_PAPER_HEADER" DefaultFormulaValue="GetOperator()" Required="true"/>
                            </Dict>
                            <Label Key="Lab_Creator" Caption="创建人" X="0" Y="1">
                                <Format HAlign="Right"/>
                            </Label>
                            <DatePicker Key="CreateTime" Caption="创建时间" BuddyKey="Lab_CreateTime" X="3" Y="1" Enable="false" CopyNew="false">
                                <DataBinding ColumnKey="CREATETIME" TableKey="TS_EXAM_PAPER_HEADER" DefaultFormulaValue="ServerDate()" Required="true"/>
                            </DatePicker>
                            <Label Key="Lab_CreateTime" Caption="创建时间" X="2" Y="1">
                                <Format HAlign="Right"/>
                            </Label>
                            <Dict Key="Modifier" Caption="修改人" BuddyKey="Lab_Modifier" X="1" Y="3" Enable="false" ItemKey="Operator" CopyNew="false" StateMask="Enable|Disable|Discard">
                                <DataBinding ColumnKey="MODIFIER" TableKey="TS_EXAM_PAPER_HEADER" DefaultFormulaValue="GetOperator()" Required="true"/>
                            </Dict>
                            <Label Key="Lab_Modifier" Caption="修改人" X="0" Y="3">
                                <Format HAlign="Right"/>
                            </Label>
                            <DatePicker Key="ModifyTime" Caption="修改时间" BuddyKey="Lab_ModifyTime" X="3" Y="3" Enable="false" CopyNew="false">
                                <DataBinding ColumnKey="MODIFYTIME" TableKey="TS_EXAM_PAPER_HEADER" DefaultFormulaValue="ServerDate()" Required="true"/>
                            </DatePicker>
                            <Label Key="Lab_ModifyTime" Caption="修改时间" X="2" Y="3">
                                <Format HAlign="Right"/>
                            </Label>
                            <RowDefCollection RowGap="5">
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                                <RowDef Height="30px"/>
                                <RowDef Height="5px"/>
                            </RowDefCollection>
                            <ColumnDefCollection ColumnGap="5">
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                                <ColumnDef Width="100px"/>
                                <ColumnDef MinWidth="100px"/>
                            </ColumnDefCollection>
                        </GridLayoutPanel>
                    </TabPanel>
                    <SplitSize Size="100%"/>
                </SplitPanel>
            </FlexFlowLayoutPanel>
        </Block>
    </Body>
    <MacroCollection>
        <Macro Key="updateDataWithRule" Args="data">
            <![CDATA[// 更新当前界面信息
SetValue("Category", data.get("category"));
SetValue("Department", data.get("department"));
SetValue("RuleId", data.get("ruleId"));
SetValue("RuleCode", data.get("ruleCode"));
SetValue("RuleDescription", data.get("ruleDescription"));
SetValue("TotalScore", data.get("totalScore"));
SetValue("PassingScore", data.get("passingScore"));
SetValue("Duration", data.get("duration"));]]>
        </Macro>
        <Macro Key="isDeleted">
            <![CDATA[// 判断记录是否已经被删除
var isDeleted = false;
isDeleted = InvokeService("PaperIsDeleted", false, false, ""&GetOID()); 
if (isDeleted) {
    Confirm("试卷已被删除,不能继续进行编辑。");
}

return isDeleted;]]>
        </Macro>
        <Macro Key="isGenerated">
            <![CDATA[// 判断试卷是否已经生成了试题
var isGenerated = false;
isGenerated = InvokeService("PaperIsGenerated", false, false, ""&GetOID()); 
if (!isGenerated) {
    Confirm("请先【生成试题】,再【启用】。");
}

return isGenerated;]]>
        </Macro>
        <Macro Key="clearRule">
            <![CDATA[// 清除规则相关数据
SetValue('RuleId', 0);
SetValue('RuleCode', '');
SetValue('RuleDescription', '');
SetValue('TotalScore', 0);]]>
        </Macro>
        <Macro Key="openRuleDetail">
            <![CDATA[// 打开规则详情
var ruleId = GetValue("RuleId"); // Confirm("rule id=" & ruleId);
if (ruleId > 0) { 
    Open("TS_ExamRuleDetail", ruleId);
}]]>
        </Macro>
    </MacroCollection>
</Form>
